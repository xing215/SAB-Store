server {
	listen 80;
	server_name localhost;
	root /usr/share/nginx/html;

	# Ensure correct MIME types are loaded
	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	# Performance optimization
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	client_max_body_size 10M;

	# Gzip compression
	gzip on;
	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_types text/plain text/css text/xml text/javascript
	           application/json application/javascript application/xml+rss
	           application/rss+xml font/truetype font/opentype
	           application/vnd.ms-fontobject image/svg+xml;
	gzip_disable "msie6";

	# Security headers
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header X-XSS-Protection "1; mode=block" always;
	add_header Referrer-Policy "no-referrer-when-downgrade" always;

	# DNS resolver - use Docker internal DNS for service discovery
	resolver 127.0.0.11 valid=10s ipv6=off;
	resolver_timeout 5s;

	# Health check endpoint
	location /health {
		access_log off;
		return 200 "healthy\n";
		add_header Content-Type text/plain;
	}

	# API requests - proxy to backend
	location /api/ {
		set $backend_upstream backend:5000;
		proxy_pass http://$backend_upstream;
		proxy_http_version 1.1;

		# Proxy headers
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Connection "";

		# Timeouts
		proxy_connect_timeout 60s;
		proxy_send_timeout 60s;
		proxy_read_timeout 60s;

		# Buffering
		proxy_buffering on;
		proxy_buffer_size 4k;
		proxy_buffers 8 4k;
		proxy_busy_buffers_size 8k;

		# Disable cache for API
		proxy_no_cache 1;
		proxy_cache_bypass 1;
	}

	# Upload endpoint - special handling for large files
	location /api/upload {
		client_max_body_size 50M;

		set $backend_upstream backend:5000;
		proxy_pass http://$backend_upstream;
		proxy_http_version 1.1;

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Connection "";

		# Extended timeouts for uploads
		proxy_connect_timeout 300s;
		proxy_send_timeout 300s;
		proxy_read_timeout 300s;

		# Request buffering off for large uploads
		proxy_request_buffering off;
	}

	# Static product images directly from MinIO (must be BEFORE regex static files location)
	location ^~ /uploads/ {
		# MinIO S3 path format: /bucket-name/object-path
		# Rewrite /uploads/products/image.png -> /sabstore/products/image.png
		rewrite ^/uploads/(.*)$ /sabstore/$1 break;
		
		proxy_pass http://minio:9000;
		proxy_http_version 1.1;
		
		# Set Host header for MinIO virtual host routing
		proxy_set_header Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		
		# MinIO specific settings
		proxy_buffering off;
		proxy_request_buffering off;
		
		# Cache static assets
		expires 7d;
		add_header Cache-Control "public, immutable";
		
		# Handle errors gracefully
		proxy_intercept_errors on;
		error_page 404 =404 /404.html;
	}

	# No cache for index.html - always serve fresh
	location = /index.html {
		add_header Cache-Control "no-cache, no-store, must-revalidate";
		add_header Pragma "no-cache";
		add_header Expires "0";
		try_files $uri =404;
	}

	# Vite assets folder - long-term cache with hash names
	location /assets/ {
		expires 1y;
		add_header Cache-Control "public, immutable";
		# Explicitly return 404 for missing files - do NOT fallback to index.html
		try_files $uri =404;
	}

	# Static files - return 404 if not found
	location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
		expires 1y;
		add_header Cache-Control "public, immutable";
		try_files $uri =404;
	}

	# Cache manifest and logos
	location ~* ^/(manifest\.json|favicon\.ico|favicon\.png|robots\.txt)$ {
		expires 7d;
		add_header Cache-Control "public";
		try_files $uri =404;
	}

	# Default - serve and fallback to index.html for SPA
	# This catches HTML routes only (after static assets are matched above)
	location / {
		index index.html;
		try_files $uri $uri/ /index.html;
		add_header Cache-Control "no-cache";
	}
}
